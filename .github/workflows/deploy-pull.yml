name: Deploy (pull) Laravel + React/Vite
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy por SSH (pull en servidor)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}          # ej: 167.71.170.142
          username: ${{ secrets.SSH_USER }}      # ej: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}    # tu id_rsa
          port: ${{ secrets.SSH_PORT || '22' }}
          script_stop: true
          script: |
            set -e
            cd "/var/www/ViajesRoxanaWeb"

            echo "ğŸš€ Iniciando deploy..."
            echo "ğŸ“ Directorio actual: $(pwd)"
            ls -la | sed 's/^/  /'
            echo "ğŸ” .git:"
            ls -ld .git || true

            echo "ğŸ” Verificando herramientas..."
            node --version || echo "âŒ Node.js no encontrado"
            npm --version || echo "âŒ npm no encontrado"
            composer --version || echo "âŒ Composer no encontrado"

            # Evitar interferencias con Git
            unset GIT_DIR GIT_WORK_TREE

            # Asegurar repo
            git rev-parse --is-inside-work-tree

            # Stash si hay cambios locales
            STASHED=0
            if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
              echo "âš ï¸ Cambios sin commitear, haciendo stash..."
              git stash push --include-untracked || true
              STASHED=1
            fi

            # Pull limpio
            echo "ğŸ”„ Haciendo git pull..."
            git fetch origin main
            git checkout main
            git pull --ff-only origin main
            echo "âœ… Pull OK"

            # Calcular archivos cambiados de forma robusta:
            # 1) Intento con HEAD@{1}..HEAD
            # 2) Si falla, marcamos "__ALL__" para forzar instalaciones
            set +e
            CHANGED=$(git diff --name-only HEAD@{1} HEAD 2>/dev/null)
            if [ $? -ne 0 ]; then
              CHANGED="__ALL__"
            fi
            set -e
            echo "ğŸ—‚ï¸ Cambios detectados:"
            printf '%s\n' "$CHANGED" | sed 's/^/  - /'

            # Si hicimos stash, restaurar (y captar cambios locales)
            CHANGED_LOCAL=""
            if [ "$STASHED" = "1" ]; then
              echo "â†©ï¸ Restaurando cambios del stash..."
              if git stash pop; then
                set +e
                CHANGED_LOCAL=$(git diff --name-only HEAD 2>/dev/null)
                set -e
              else
                echo "â— Conflictos al aplicar el stash. Revisa 'git status' en el servidor."
                exit 1
              fi
            fi

            # Composer si cambiÃ³ composer.json/lock (por pull o stash)
            if printf '%s\n%s\n' "$CHANGED" "$CHANGED_LOCAL" | grep -E -q '(^|/)composer\.json|(^|/)composer\.lock|^__ALL__$'; then
              echo "ğŸ“¦ Composer install..."
              export COMPOSER_ALLOW_SUPERUSER=1
              composer install --no-dev --optimize-autoloader --no-interaction
            else
              echo "âœ… Composer sin cambios"
            fi

            # npm si cambiÃ³ package.* / lockfiles (por pull o stash)
            if printf '%s\n%s\n' "$CHANGED" "$CHANGED_LOCAL" | grep -E -q '(^|/)package\.json|(^|/)package-lock\.json|(^|/)pnpm-lock\.yaml|(^|/)yarn\.lock|^__ALL__$'; then
              echo "ğŸ“¦ npm deps..."
              if [ -f package-lock.json ]; then npm ci; else npm install; fi
            else
              echo "âœ… npm sin cambios"
            fi

            # Migraciones sÃ³lo si hay pendientes
            echo "ğŸ—„ï¸ Verificando migraciones..."
            if php artisan migrate:status --no-interaction | awk -F'|' 'NR>2 && $0 ~ /No/ {p=1} END{exit(!p)}'; then
              echo "ğŸ—„ï¸ Ejecutando migraciones..."
              php artisan migrate --force --no-interaction
            else
              echo "âœ… No hay migraciones pendientes"
            fi

            # Build Vite
            echo "ğŸ—ï¸ Construyendo assets con Vite..."
            npm run build || echo "âš ï¸ Build omitido (sin Node/npm)"

            # Limpiar y optimizar cache
            echo "ğŸ§¹ Limpiando cache..."
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true

            echo "âš¡ Optimizando..."
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true
            php artisan storage:link || true

            # Permisos
            echo "ğŸ” Estableciendo permisos..."
            mkdir -p storage/framework/{cache,sessions,views} bootstrap/cache
            chmod -R 775 storage bootstrap/cache || true
            chown -R www-data:www-data storage bootstrap/cache || true

            # Recargar PHP-FPM
            echo "ğŸ” Recargando PHP-FPM..."
            systemctl reload php8.3-fpm || systemctl reload php8.2-fpm || systemctl reload php-fpm || true

            echo "âœ… Deploy completado exitosamente!"
