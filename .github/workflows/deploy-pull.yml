name: Deploy Laravel + React/Vite (Always Run)
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy por SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script_stop: true
          script: |
            set -e  # Detener si hay errores
            
            # Cargar variables de entorno
            source ~/.bashrc 2>/dev/null || true
            source ~/.nvm/nvm.sh 2>/dev/null || true
            
            # Ruta del proyecto
            cd /var/www/ViajesRoxanaWeb
            
            echo "ğŸš€ Iniciando deploy..."
            echo "ğŸ“ Directorio actual: $(pwd)"
            
            # Verificar herramientas
            echo "ğŸ” Verificando herramientas..."
            node --version
            npm --version
            composer --version
            
            # Git pull
            echo "ğŸ”„ Actualizando cÃ³digo..."
            git pull origin main
            
            # Siempre ejecutar composer (mÃ¡s lento pero mÃ¡s seguro)
            echo "ğŸ“¦ Instalando dependencias de Composer..."
            export COMPOSER_ALLOW_SUPERUSER=1
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Siempre ejecutar npm
            echo "ğŸ“¦ Instalando dependencias de npm..."
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
            
            # Siempre intentar migraciones
            echo "ğŸ—„ï¸ Ejecutando migraciones..."
            php artisan migrate --force --no-interaction || echo "âœ… No hay migraciones o ya ejecutadas"
            
            # Build assets
            echo "ğŸ—ï¸ Construyendo assets..."
            npm run build
            
            # Limpieza y optimizaciÃ³n Laravel
            echo "ğŸ§¹ Limpiando cache..."
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            
            echo "âš¡ Optimizando para producciÃ³n..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Storage link
            php artisan storage:link || echo "âœ… storage:link ya existe"
            
            # Permisos
            echo "ğŸ” Estableciendo permisos..."
            mkdir -p storage/framework/{cache,sessions,views} bootstrap/cache
            chmod -R 775 storage bootstrap/cache
            
            echo "âœ… Deploy completado exitosamente!"