name: Deploy (pull) Laravel + React/Vite
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy por SSH (pull en servidor)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}          # ej: 167.71.170.142
          username: ${{ secrets.SSH_USER }}      # ej: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}    # tu id_rsa
          port: ${{ secrets.SSH_PORT || '22' }}
          script_stop: true
          script: |
            set -e
            cd ${{ secrets.PROJECT_PATH }}

            echo "ğŸš€ Iniciando deploy..."
            echo "ğŸ“ Directorio actual: $(pwd)"

            echo "ğŸ” Verificando herramientas..."
            node --version || echo "âŒ Node.js no encontrado"
            npm --version || echo "âŒ npm no encontrado"
            composer --version || echo "âŒ Composer no encontrado"

            # Stash si hay cambios locales
            STASHED=0
            if [ -n "$(git status --porcelain)" ]; then
              echo "âš ï¸ Cambios sin commitear, haciendo stash..."
              git stash push --include-untracked || true
              STASHED=1
            fi

            # Guardar HEAD previo y traer cambios limpios
            PREV_HEAD=$(git rev-parse HEAD || echo "")
            git fetch origin main
            git checkout main
            echo "ğŸ”„ Haciendo git pull..."
            git pull --ff-only origin main

            # Cambios del pull
            if [ -n "$PREV_HEAD" ]; then
              CHANGED="$(git diff --name-only "$PREV_HEAD"...HEAD || true)"
            else
              CHANGED="$(git diff --name-only HEAD~1 HEAD || true)"
            fi

            # Restaurar cambios del stash (si hubo)
            CHANGED_LOCAL=""
            if [ "$STASHED" = "1" ]; then
              echo "â†©ï¸ Restaurando cambios del stash..."
              if git stash pop; then
                CHANGED_LOCAL="$(git diff --name-only HEAD || true)"
              else
                echo "â— Conflictos al aplicar el stash. Revisa 'git status' y resuÃ©lvelos."
                exit 1
              fi
            fi

            # Composer si cambiÃ³ composer.json/lock (por pull o por stash)
            if echo "$CHANGED" | grep -E -q '(^|/)composer\.json|(^|/)composer\.lock' \
               || echo "$CHANGED_LOCAL" | grep -E -q '(^|/)composer\.json|(^|/)composer\.lock'; then
              echo "ğŸ“¦ Instalando dependencias de Composer..."
              composer install --no-dev --optimize-autoloader --no-interaction
            fi

            # npm si cambiÃ³ package.* / lockfiles (por pull o por stash)
            if echo "$CHANGED" | grep -E -q '(^|/)package\.json|(^|/)package-lock\.json|(^|/)pnpm-lock\.yaml|(^|/)yarn\.lock' \
               || echo "$CHANGED_LOCAL" | grep -E -q '(^|/)package\.json|(^|/)package-lock\.json|(^|/)pnpm-lock\.yaml|(^|/)yarn\.lock'; then
              echo "ğŸ“¦ Instalando dependencias de npm..."
              if [ -f package-lock.json ]; then npm ci; else npm install; fi
            fi

            # Migraciones sÃ³lo si hay pendientes
            echo "ğŸ—„ï¸ Verificando migraciones..."
            if php artisan migrate:status --no-interaction | awk -F'|' 'NR>2 && $0 ~ /No/ {p=1} END{exit(!p)}'; then
              echo "ğŸ—„ï¸ Ejecutando migraciones..."
              php artisan migrate --force --no-interaction
            else
              echo "âœ… No hay migraciones pendientes"
            fi

            # Build Vite
            echo "ğŸ—ï¸ Construyendo assets con Vite..."
            npm run build || echo "âš ï¸ Build omitido (sin Node/npm)"

            # Limpiar y optimizar cache
            echo "ğŸ§¹ Limpiando cache..."
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true

            echo "âš¡ Optimizando..."
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true
            php artisan storage:link || true

            # Permisos
            echo "ğŸ” Estableciendo permisos..."
            mkdir -p storage/framework/{cache,sessions,views} bootstrap/cache
            chmod -R 775 storage bootstrap/cache || true

            # Recargar PHP-FPM
            systemctl reload php8.3-fpm || systemctl reload php8.2-fpm || systemctl reload php-fpm || true

            echo "âœ… Deploy completado exitosamente!"
